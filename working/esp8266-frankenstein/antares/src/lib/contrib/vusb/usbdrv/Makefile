objects-y+=usbdrv.o usbdrvasm.o oddebug.o
gen-y+=usbconfig

#Nothing can describe, how much this thing sucks

U_VID=$(shell $(ANTARES_DIR)/scripts/avr/vusb_id $(CONFIG_USB_CFG_VENDOR_ID))
U_PID=$(shell $(ANTARES_DIR)/scripts/avr/vusb_id $(CONFIG_USB_CFG_DEVICE_ID))
U_VER=$(shell $(ANTARES_DIR)/scripts/avr/vusb_id $(CONFIG_USB_CFG_DEVICE_VERSION))

$(eval $(shell $(ANTARES_DIR)/scripts/avr/vusb_str USB_CFG_VENDOR_NAME $(CONFIG_USB_CFG_VENDOR_NAME) str ))
$(eval $(shell $(ANTARES_DIR)/scripts/avr/vusb_str USB_CFG_VENDOR_NAME $(CONFIG_USB_CFG_VENDOR_NAME) len ))

define vusb_def_string
	@$(eval $(shell $(ANTARES_DIR)/scripts/avr/vusb_str $(1) $(CONFIG_$(1)) str ))
	@$(eval $(shell $(ANTARES_DIR)/scripts/avr/vusb_str $(1) $(CONFIG_$(1)) len ))
	@echo "#define $(1) $($(1))"  >> $(TOPDIR)/include/generated/usbconfig.h
	@echo "#define $(1)_LEN $($(1)_LEN)"  >> $(TOPDIR)/include/generated/usbconfig.h
endef

define append
	@echo "$(1)" >> $(TOPDIR)/include/generated/usbconfig.h
endef

usbconfig:
	$(SILENT_GEN) echo "//autogenerated" > $(TOPDIR)/include/generated/usbconfig.h
	@$(call append,#define USB_CFG_IOPORTNAME $(call unquote,$(CONFIG_USB_CFG_IOPORTNAME)))
	@$(call append,#define USB_CFG_PULLUP_IOPORTNAME $(call unquote,$(CONFIG_USB_CFG_PULLUP_IOPORTNAME)))
	@$(call append,#define USB_CFG_VENDOR_ID $(U_VID))
	@$(call append,#define USB_CFG_DEVICE_ID $(U_PID))
	@$(call append,#define USB_CFG_DEVICE_VERSION $(U_VER))
	@$(call vusb_def_string,USB_CFG_VENDOR_NAME)
	$(call vusb_def_string,USB_CFG_DEVICE_NAME)
	$(call vusb_def_string,USB_CFG_SERIAL_NUMBER)
	$(call append,#include <arch/vusb/usbconfig.h>)

